{{- $src := partial "utils/lib.html" (dict "$" . "type" "mathjax") -}}

<script>
    // MathJax 3 Configuration
    window.MathJax = {
        loader: {
            load: ['[tex]/mhchem']
        },
        tex: {
            inlineMath: {'[+]': [['$', '$']]},
            tags: 'ams',
            packages: {'[+]': ['mhchem']}
        },
        options: {
            {{ if .Site.Params.disableMathJaxMenu }}
            renderActions: {
                addMenu: [0, '', '']
            },
            {{ end }}
            // Ignore dynamic areas to avoid replaceChild errors
            ignoreHtmlClass: 'waline-container|comment-content',
            processHtmlClass: 'tex2jax_process'
        },
        startup: {
            typeset: false, // Disable initial auto-typesetting
            ready: () => {
                MathJax.startup.defaultReady();
                MathJax.startup.promise.then(() => {
                    // Only typeset stable content containers
                    const containers = document.querySelectorAll('.post-body, .summary, .home-header');
                    if (containers.length > 0) {
                        MathJax.typesetPromise(Array.from(containers)).catch(e => console.debug("MathJax error:", e));
                    } else {
                        MathJax.typesetPromise().catch(e => console.debug("MathJax error:", e));
                    }
                });
            }
        }
    };

    (function() {
        if (typeof MathJax === 'undefined') {
            const script = document.createElement('script');
            script.src = '{{ $src }}';
            script.defer = true;
            document.head.appendChild(script);
        } else {
            // Defensive check for MathJax.startup.promise to avoid "reading 'then' of undefined"
            if (MathJax.startup && MathJax.startup.promise) {
                MathJax.startup.promise.then(() => {
                    if (typeof MathJax.typesetPromise === 'function') {
                        MathJax.typesetPromise().catch(e => console.debug("MathJax typeset failed:", e));
                    }
                });
            } else if (typeof MathJax.typesetPromise === 'function') {
                MathJax.typesetPromise().catch(e => console.debug("MathJax typeset failed:", e));
            }
        }
    })();
</script>