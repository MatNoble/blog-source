name: IndexNow Submit

on:
  push:
    branches:
      - main
    paths:
      - "content/**"

jobs:
  submit-indexnow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Collect updated URLs
        id: urls
        run: |
          BASE_URL="https://blog.matnoble.top"
          echo "{" > urls.json
          echo '  "host": "blog.matnoble.top",' >> urls.json
          echo '  "key": "753ff71146b144a2a2c03a5455c68294",' >> urls.json
          echo '  "keyLocation": "https://blog.matnoble.top/753ff71146b144a2a2c03a5455c68294.txt",' >> urls.json
          echo '  "urlList": [' >> urls.json

          git diff --name-only HEAD^ HEAD \
            | grep '^content/' \
            | grep -E '\.(md|markdown)$' \
            | sed 's|^content||; s|\.md$|/|' \
            | sed "s|^|    \"${BASE_URL}|" \
            | sed 's|$|\",|' >> urls.json

          sed -i '$ s/,$//' urls.json
          echo '  ]' >> urls.json
          echo '}' >> urls.json

          cat urls.json

      - name: Submit to IndexNow
        run: |
          curl -X POST "https://api.indexnow.org/indexnow" \
            -H "Content-Type: application/json" \
            --data-binary @urls.json