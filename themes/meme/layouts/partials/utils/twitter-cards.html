<!-- https://developer.twitter.com/en/docs/tweets/optimize-with-cards/guides/getting-started -->
<!-- https://cards-dev.twitter.com/validator -->
<!-- https://github.com/gohugoio/hugo/blob/master/tpl/tplimpl/embedded/templates/twitter_cards.html -->
{{- $ := index . "$" -}}
<!-- Author -->
{{- $author := partial "utils/author.html" $ -}}

{{- $processedImage := "" -}}
{{- $imageFound := false -}}

<!-- Try to get and process images from $images slice -->
{{- $images := partial "utils/images.html" $ -}}
{{- with $images -}}
    {{- range $imgURL := . -}}
        {{- if not $imageFound -}}
            {{- $imageResource := "" -}}
            {{- if $.Page.Resources.GetMatch $imgURL -}}
                {{- $imageResource = $.Page.Resources.GetMatch $imgURL -}}
            {{- else if $.Site.GetPage $imgURL -}}
                {{- /* If $imgURL is a path to a page bundle, try to get its main image */ -}}
                {{- $imageResource = $.Site.GetPage $imgURL -}}
                {{- if $imageResource -}}
                    {{- $imageResource = $imageResource.Resources.GetMatch "*{.png,.jpg,.jpeg,.gif,.webp,.svg}" -}}
                {{- end -}}
            {{- else -}}
                {{- /* Try to get the image from site-wide assets or static folder */ -}}
                {{- $imageResource = $.Site.GetPage (path.Dir $imgURL) -}}
                {{- with $imageResource -}}
                    {{- $imageResource = .Resources.GetMatch (path.Base $imgURL) -}}
                {{- end -}}
            {{- end -}}

            {{- if $imageResource -}}
                {{- if $imageResource.MediaType.IsImage -}}
                    {{- $processed := $imageResource.Fill "1200x675 webp q80" -}}
                    {{- $processedImage = $processed.Permalink -}}
                    {{- $imageFound = true -}}
                {{- end -}}
            {{- else if hasPrefix $imgURL "/" -}}
                {{- /* If still not found as local resource (might be in static or directly in assets outside of bundle) */ -}}
                {{- /* For images in /static, we don't need resource processing; just absURL */ -}}
                {{- /* For images in /assets, they need to be defined as page resources of the site itself */ -}}
                {{- $staticImage := $.Site.GetPage "static" -}}
                {{- with $staticImage -}}
                    {{- $resourceFromStatic := .Resources.GetMatch (strings.TrimPrefix "/static/" $imgURL) -}}
                    {{- if $resourceFromStatic -}}
                        {{- $processed := $resourceFromStatic.Fill "1200x675 webp q80" -}}
                        {{- $processedImage = $processed.Permalink -}}
                        {{- $imageFound = true -}}
                    {{- end -}}
                {{- end -}}
            {{- end -}}
            
            {{- if not $imageFound -}}
                {{- /* If still not found as local resource, use original URL (could be external or unhandled local path) */ -}}
                {{- $processedImage = $imgURL | absURL -}}
                {{- $imageFound = true -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

<!-- Fallback to siteLogo if no other image is found -->
{{- if not $imageFound -}}
    {{- with $.Site.Params.siteLogo -}}
        {{- $siteLogoPath := . -}}
        {{- $siteLogoResource := "" -}}
        
        {{- if $.Page.Resources.GetMatch $siteLogoPath -}}
            {{- $siteLogoResource = $.Page.Resources.GetMatch $siteLogoPath -}}
        {{- else -}}
            {{- /* Try to get the site logo from site-wide resources (e.g., /static) */ -}}
            {{- $staticImage := $.Site.GetPage "static" -}}
            {{- with $staticImage -}}
                {{- $siteLogoResource = .Resources.GetMatch (strings.TrimPrefix "/static/" $siteLogoPath) -}}
            {{- end -}}
        {{- end -}}

        {{- if $siteLogoResource -}}
            {{- if $siteLogoResource.MediaType.IsImage -}}
                {{- $processed := $siteLogoResource.Fill "1200x675 webp q80" -}}
                {{- $processedImage = $processed.Permalink -}}
                {{- $imageFound = true -}}
            {{- end -}}
        {{- end -}}
        {{- if not $imageFound -}}
            {{- $processedImage = . | absURL -}}
            {{- $imageFound = true -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- if $processedImage -}}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content="{{ $processedImage }}" />
{{- else -}}
    <meta name="twitter:card" content="summary" />
{{- end -}}

{{ with $.Site.Params.siteTwitter -}}
    <meta name="twitter:site" content="@{{ . }}" />
{{ end -}}
{{ with $author.twitter -}}
    <meta name="twitter:creator" content="@{{ . }}" />
{{ end -}}
